function isFunction(t){return!!t&&!t.nodeName&&t.constructor!=String&&t.constructor!=RegExp&&t.constructor!=Array&&/function/i.test(t+"")}function numSplit(t){t+="";var e=t.split(".");return e={integer:1*e[0],decimal:1*("0."+e[1])}}function Class(t,e){function i(){initializing||(t&&(this.baseprototype=t.prototype),this.construct.apply(this,arguments))}"object"==typeof t&&(e=t,t=null),t&&(initializing=!0,i.prototype=new t,i.prototype.constructor=i,initializing=!1);for(var o in e)e.hasOwnProperty(o)&&(i.prototype[o]=t&&"function"==typeof e[o]&&"function"==typeof i.prototype[o]?function(e,i){return function(){return this["super"]=t.prototype[e],i.apply(this,arguments)}}(o,e[o]):e[o]);return i}function preload(){}function create(){game.canvas.getContext("2d")||game.canvas.getContext("webgl"),game.stage.backgroundColor=2899536,init()}function onDrag(t){mouse=t}function onHit(t,e,i,o){t&&t.parent instanceof MyBox&&(t.parent.destroy(),boxes.arr[t.parent.vessel.i].length--,boxes.arr[t.parent.vessel.i].row[t.parent.vessel.j]=null,0==boxes.arr[t.parent.vessel.i].length&&(boxes.rows--,console.log(boxes.arr[t.parent.vessel.i].length," ",boxes.rows)),score++)}function restart(){console.log("restart"),button.hide(),text.hide(),console.log(game),clearInterval(timeinterval),score=0,init()}function init(){if(game.isRunning=!0,game.physics.startSystem(Phaser.Physics.P2JS),game.physics.p2.gravity.y=0,game.physics.p2.restitution=.9,circle){circle.destroy(),tab.destroy();for(var t=0;t<boxes.arr.length;t++)for(var e=0;e<boxes.arr[t].row.length;e++){var i=boxes.arr[t].row[e];i&&i.destroy()}}circle=new MyCircle(winWidth>>1,winHeight>>1,10,200),tab=new MyTabRet(winWidth>>1,.66*winHeight,80,10);var o=numSplit((game.width-box_space)/(box_width+box_space));box_total=o.integer,boxpos={x:(game.width-(box_total*box_width+(box_total-1)*box_space))/2+box_width/2,y:box_width/2+box_space,resetx:function(){this.x=(game.width-(box_total*box_width+(box_total-1)*box_space))/2+box_width/2}};for(var t=0;1>t;t++){boxes.arr[t]={row:[]};for(var e=0;box_total>e;e++)boxes.arr[t].row[e]=new MyBox(boxpos.x,boxpos.y,box_width,"haha"),boxes.arr[t].row[e].vessel.i=t,boxes.arr[t].row[e].vessel.j=e,boxpos.x+=box_width+box_space;boxes.arr[t].length=box_total,boxpos.resetx(),boxpos.y+=box_width+box_space}boxes.rows=1,boxpos.resetx(),boxpos.y=-box_width/2,timeinterval=setTimeout(timecount,5e3),game.input.addMoveCallback(onDrag,this),circle.body.onBeginContact.add(onHit,this)}function update(){if(game.isRunning){if(circle.update(),tab.update(),mouse)if(mouse.position.x<tab.body.x-tab.width/2||mouse.position.x>tab.body.x+tab.width/2){var t=mouse.position.x-tab.body.x;tab.body.velocity.x=10*t}else tab.body.velocity.x=0;tab.body.x-tab.width/2<0?(tab.body.x=tab.width/2+.5,tab.body.velocity.x=0):tab.body.x+tab.width/2>game.width&&(tab.body.x=game.width-tab.width/2-.5,tab.body.velocity.x=0),circle.body.y>tab.body.y&&(console.log("Over! Score:"+score),game.physics.destroy(),text.html("Game Over!"),text.show(),button.html("重新开始"),button.show(),button.one("click",function(){restart()}),game.isRunning=!1);for(var e=0;e<boxes.arr.length;e++)for(var i=0;i<boxes.arr[e].row.length;i++){var o=boxes.arr[e].row[i];o&&(o.update(),o.is_moving&&o.body.y>=o.last_y+box_width+box_space&&(o.body.y=o.last_y+box_width+box_space,o.body.velocity.y=0,o.is_moving=!1))}}}function render(){}function timecount(){if(boxes.rows<3&&game.isRunning){var t={row:[]};boxes.arr.push(t);for(var e=0;box_total>e;e++)t.row[e]=new MyBox(boxpos.x,boxpos.y,box_width,"haha"),t.row[e].vessel.i=boxes.arr.length-1,t.row[e].vessel.j=e,boxpos.x+=box_width+box_space;t.length=box_total,boxpos.resetx(),boxes.rows++;for(var i=0;i<boxes.arr.length;i++)for(var o=0;o<boxes.arr[i].row.length;o++){var s=boxes.arr[i].row[o];s&&(s.is_moving=!0,s.last_y=s.body.y,s.body.velocity.y=2*box_width)}}timeinterval=setTimeout(timecount,5e3)}var MyPhyObject=Class({construct:function(t,e,i){this.x=t,this.y=e,this.feather=game.add.graphics(this.x,this.y),this.sprite=game.add.sprite(this.x,this.y),game.physics.p2.enable(this.sprite),this.body=this.sprite.body,this.body.parent=this,this.display()},display:function(){},update:function(){this.feather.x=this.body.x,this.feather.y=this.body.y,this.motion&&this.motion()},destroy:function(){this.sprite.kill();try{this.sprite.parent.removeChild(this.sprite),this.feather.parent.removeChild(this.feather)}catch(t){}},reset:function(t,e,i){console.log(this.body.y),this.body.x=t,this.body.y=e,i||(i=[0,0])}}),MyCircle=Class(MyPhyObject,{construct:function(t,e,i,o){this.radius=i,this.speed=o,this["super"](t,e),this.body.velocity.y=-1,this.body.velocity.x=.3*Math.random()-.15},display:function(){this.feather.lineStyle(0),this.feather.beginFill(16777215),this.feather.drawCircle(0,0,2*this.radius+.5),this.feather.endFill(),this.body.setCircle(this.radius)},motion:function(){if(0!=this.body.velocity.y){var t=Math.atan2(this.body.velocity.y,this.body.velocity.x);this.body.velocity.x=Math.cos(t)*this.speed,this.body.velocity.y=Math.sin(t)*this.speed}}}),MyTabRet=Class(MyPhyObject,{construct:function(t,e,i,o,s){this.width=i,this.height=o,this["super"](t,e),this.body.kinematic=!0},display:function(){this.feather.lineStyle(0),this.feather.beginFill(16777215),this.feather.drawRect(-this.width/2,-this.height/2,this.width,this.height),this.feather.endFill(),this.body.setRectangle(this.width,this.height)}}),MyBox=Class(MyPhyObject,{construct:function(t,e,i,o){this.width=i,this.height=i,this.type=o,this["super"](t,e),this.body.kinematic=!0,this.is_moving=!1,this.last_y=e,this.vessel={i:0,j:0}},display:function(){switch(this.type){default:case"normal":this.feather.lineStyle(0),this.feather.beginFill(16777215),this.feather.drawRect(-this.width/2,-this.height/2,this.width,this.height),this.feather.endFill(),this.body.setRectangle(this.width,this.height);break;case"haha":this.feather.lineStyle(0),this.feather.beginFill(16777215),this.feather.drawRect(-this.width/2,-this.height/2,this.width,this.height),this.feather.endFill(),this.feather.beginFill(2899536),this.feather.drawRect(.6*-this.width/2,.6*-this.height/2,.6*this.width,.6*this.height),this.feather.endFill(),this.body.setRectangle(this.width,this.height)}}}),initializing=!1;console.log("'Allo 'Allo!");var winHeight,winWidth,game,text,button;$(function(){document.documentElement&&document.documentElement.clientHeight&&document.documentElement.clientWidth?(winHeight=document.documentElement.clientHeight,winWidth=document.documentElement.clientWidth):(winHeight=window.innerHeight,winWidth=window.innerWidth),text=$("#text"),button=$("#button"),text.css("margin-left",-text.width()/2).show(),$("#game").width(winWidth).height(winHeight),button.one("click",function(){game=new Phaser.Game(winWidth,winHeight,Phaser.CANVAS,"game",{preload:preload,create:create,update:update,render:render},!1,!0),$(this).hide(),text.hide()})});var score=0,curr_rows=0,box_total=0,box_offset=0,box_width=30,box_space=10,timeinterval,boxes={arr:[],rows:0},boxpos={},circle,tab,mouse;